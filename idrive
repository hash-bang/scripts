#!/bin/bash
HELP="
Utility command functions for iDrive360

Usage: idrive <command>

Commands:

idrive help              This help screen

idrive start             Start the iDrive Cron + system task

idrive stop              Try to (politely) shut down the iDrive process

idrive kill              Try to agressively shut down any remaining iDrive processess
"

# Utility functions {{{

# Return if the iDrive process is running
# @example
# if idriveIsRunning 'idrive'; then; ...; fi
function idriveIsRunning() {
	[ "$(pgrep -cif idrive)" -gt 0 ]
}

# Try to close down iDrive politely
function idriveClose {
	echo "Stopping iDrive process"
	sudo /opt/idrive360/Idrivelib/dependencies/python/idrive360 stop

	echo "Stop iDrive cron system unit"
	sudo systemctl stop idrive360cron
}

# Politely kill any remaining iDrive processes
function idriveClosePolite {
	pgrep -if idrive | grep -v $$ | sudo xargs -r kill
}

# Violently close iDrive
function idriveCloseViolent {
	pgrep -if idrive | grep -v $$ | sudo xargs -r kill -9
}
# }}}


CMD="$1"
case "$CMD" in
	"help")
		echo "$HELP"
		exit
		;;


	"check")
		if [ ! -e "/opt/idrive360/Idrivelib/dependencies/perl/perl" ]; then
			echo "Perl dependency missing - fixing"
			sudo ln -s /usr/bin/perl /opt/idrive360/Idrivelib/dependencies/perl/perl
		else
			echo "Perl dependency OK"
		fi
		exit 0
		;;


	"query")
		if idriveIsRunning; then
			echo "iDrive is NOT running"
		else
			echo "iDrive IS running"
		fi
		exit 0
		;;


	"start")
		if idriveIsRunning; then
			echo "iDrive already running"
			exit 0
		fi

		echo "Starting main iDrive process"
		sudo /opt/idrive360/Idrivelib/dependencies/python/idrive360 6
		echo

		echo "Installing Cron system unit"
		sudo /opt/idrive360/Idrivelib/dependencies/python/idrive360 7
		echo

		echo "Starting Cron unit"
		sudo systemctl start idrive360cron

		exit 0
		;;

	"stop")
		if idriveIsRunning; then
			echo "iDrive not running"
			exit 0
		fi

		idriveClosePolite

		exit 0
		;;

	"kill")
		if ! idriveIsRunning; then
			echo "iDrive not running"
			exit 0
		fi

		echo "Politely stopping iDrive services"
		idriveClose

		if ! idriveIsRunning; then
			echo "iDrive exited correctly"
			exit 0
		fi

		echo "iDrive still running - waiting 10s + polite kill"
		sleep 10

		echo "Politely killing iDrive processes"
		idriveClosePolite

		while idriveIsRunning; do
			echo "iDrive still running - waiting 10s + agressive kill"
			sleep 10

			echo "Agressively killing iDrive processes"
			idriveCloseViolent
		done

		exit 0
		;;

	*)
		echo "Unknown iDrive comamnd"
		exit 1
esac
